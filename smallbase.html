<html>
<head>
  <meta charset="utf-8">
  <style>

  </style>
  <link rel="stylesheet" href="css/style.css" type="text/css">
</head>
<body onload="getListOfSMBS()">

<main>
  <h1>Node.js love</h1>
  <div class="smallbase-main">

    <div class="list-of-smbs-holder">
      <p>Please select a Smallbase</p>
      <div id="list-of-smbs">
        Loading ...
      </div>
    </div>

  </div>
</main>

<script>
  function getListOfSMBS(){
    console.log("Wait");
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        console.log("Done");
        var r = JSON.parse(this.responseText);
        console.log(r);
        document.getElementById("list-of-smbs").innerHTML = "";
        for (var i = 0; i < r.filelist.length; i++) {
          document.getElementById("list-of-smbs").innerHTML += '<button data-user="'+r.user+'" data-file="'+r.filelist[i]+'" type="button" onclick="openFileSmb(event)">'+r.filelist[i]+'</button>';
        }
      }
    };
    var data = {
      whattodo:"getListOfSMBS",
      user:"admin"
    };
    var url = document.location.hostname+'/createfile?json=write&data=' + JSON.stringify(data);
    xhttp.open("GET", url, true);
    xhttp.send();
  }

  /*make out file*/
  function openFileSmb(btn){
    console.log("Wait file");
    console.log("Opening");
    var file = btn.target.dataset.file;
    file = file.split(".")[0];
    var user = btn.target.dataset.user;
    console.log(file);
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        console.log("Done");
        var r = JSON.parse(this.responseText);
        console.log(r.content);
        document.getElementById("list-of-smbs").innerHTML += "<div class='smb-opened'>" + syntaxHighlight(r.content) + "</div>";
      }
    };
    var data = {
      whattodo:"opensmbs",
      filename:file,
      user:user,
    };
    console.log(data);
    var url = document.location.hostname+'/createfile?json=write&data=' + JSON.stringify(data);
    console.log(url);
    xhttp.open("GET", url, true);
    xhttp.send();

  }

  function syntaxHighlight(json) {
      if (typeof json != 'string') {
           json = JSON.stringify(json, undefined, 2);
      }
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          var cls = 'number';
          if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                  cls = 'key';
              } else {
                  cls = 'string';
              }
          } else if (/true|false/.test(match)) {
              cls = 'boolean';
          } else if (/null/.test(match)) {
              cls = 'null';
          }
          return '<div class="' + cls + '">' + match + '</div>';
      });
  }
</script>

</body>
</html>
