<html>
<head>
  <meta charset="utf-8">
  <style>

  </style>
  <link rel="stylesheet" href="css/style.css" type="text/css">
</head>
<body onload="localStorageData()">

<main>
  <h1>Node.js love</h1>
  <div class="smallbase-main">

    <div class="list-of-smbs-holder">
      <p>Please select a Smallbase</p>
      <div id="list-of-smbs">
        Loading ...
      </div>
    </div>

  </div>
</main>

<script>
//reset localStorage
//localStorage.removeItem("savedData");

  var savedData;
  function putToSavedData(data,against){
    if( against == "lastOpenedSB" ){
      if (savedData != null){
        if(savedData.lastOpenedSB == data){
          console.log(against + " already saved");
        }else{
          console.log(against + " was updated to last opened");
          savedData.lastOpenedSB = data;
          localStorage.setItem("savedData", JSON.stringify(savedData));
        }
      }else{
        savedData = {};
        savedData.lastOpenedSB = data;
        localStorage.setItem("savedData", JSON.stringify(savedData));
        console.log(data + " saved");
      }
    }
    console.log("localStorage now: ", JSON.parse(localStorage.getItem("savedData")));
  }

  function localStorageData(){
    savedData = localStorage.getItem("savedData");
    console.log("saved data: " + savedData);
    if (savedData != null){
      console.log("data exists");
      savedData = JSON.parse(savedData);

      getListOfSMBS(savedData.lastOpenedSB);
    }else{
      getListOfSMBS();
    }
  }

  function getListOfSMBS(openedDefault){
    console.log("Wait");
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        console.log("Done");
        var r = JSON.parse(this.responseText);
        console.log(r);
        document.getElementById("list-of-smbs").innerHTML = "";
        for (var i = 0; i < r.filelist.length; i++) {
          document.getElementById("list-of-smbs").innerHTML += '<button data-user="'+r.user+'" data-file="'+r.filelist[i]+'" type="button" onclick="openFileSmb(event)">'+r.filelist[i]+'</button>';
        }
      }
    };
    var data = {
      whattodo:"getListOfSMBS",
      user:"admin"
    };
    var url = document.location.hostname+'/createfile?json=write&data=' + JSON.stringify(data);
    xhttp.open("GET", url, true);
    xhttp.send();
  }

  var temp = "";
  function jsonPrinter(o,depth){
    for(var index in o) {
      var attr = o[index];

      if( typeof attr === 'object' ){
        depth++;
        temp += "<div class='depth-val-"+depth+" parent-for-object'><span class='parent-span'>"+index+"</span></div>";
        jsonPrinter(attr,depth);

      }else{
        temp += "<div class='depth-val-"+depth+" row-inner'><span class='parent-span'>"+index+"</span><span class='child-span'>"+attr+"</span></div>";
        //divified += "<div class='depth-val-"+depth+"'><span>"+index+"</span>:<span>"+attr+"</span></div>";
        //console.log(index,attr);
      }
    }
    return temp;
  }
  /*make out file*/
  function openFileSmb(btn){
    temp = "";
    if( document.getElementById("content-of-SB") ){
      document.getElementById("content-of-SB").remove();
    }

    console.log("Wait file");
    console.log("Opening");
    var file = btn.target.dataset.file;
    file = file.split(".")[0];
    var user = btn.target.dataset.user;
    console.log(file);
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        putToSavedData(file,"lastOpenedSB");
        console.log("Done");
        var r = JSON.parse(this.responseText);

        var sb = jsonPrinter(r.content,0);

        document.getElementById("list-of-smbs").innerHTML += "<div id='content-of-SB' class='smb-opened'>" + sb + "</div>";
      }
    };
    var data = {
      whattodo:"opensmbs",
      filename:file,
      user:user,
    };
    console.log(data);
    var url = document.location.hostname+'/createfile?json=write&data=' + JSON.stringify(data);
    console.log(url);
    xhttp.open("GET", url, true);
    xhttp.send();

  }

  function syntaxHighlight(json) {
      if (typeof json != 'string') {
           json = JSON.stringify(json, undefined, 2);
      }
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          var cls = 'number not-key';
          if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                  cls = 'key';
              } else {
                  cls = 'string not-key';
              }
          } else if (/true|false/.test(match)) {
              cls = 'boolean not-key';
          } else if (/null/.test(match)) {
              cls = 'null not-key';
          }
          return '<span class="' + cls + '">' + match + '</span>';
      });
  }
</script>

</body>
</html>
